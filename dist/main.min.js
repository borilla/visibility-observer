(function (global, factory) {
	typeof exports === 'object' && typeof module !== 'undefined' ? module.exports = factory() :
	typeof define === 'function' && define.amd ? define(factory) :
	(global.VisibilityObserver = factory());
}(this, (function () { 'use strict';

function IntersectionObserverWrapper(window) {
	this._intersectionObserver = new window.IntersectionObserver(this._handleIntersectionChanged.bind(this));
	this._observing = new Map();
}

IntersectionObserverWrapper.prototype.observe = function (element, onVisibilityChanged) {
	this._intersectionObserver.observe(element);
	this._observing.set(element, onVisibilityChanged);
};

IntersectionObserverWrapper.prototype.unobserve = function (element) {
	this._intersectionObserver.unobserve(element);
	this._observing.delete(element);
};

IntersectionObserverWrapper.prototype._handleIntersectionChanged = function (entries) {
	var observing = this._observing;

	entries.forEach(function (entry) {
		var isVisible = entry.intersectionRatio > 0;
		var element = entry.target;
		var onVisibilityChanged = observing.get(element);

		onVisibilityChanged(isVisible, element);
	});
};

var intersectionObserverWrapper = IntersectionObserverWrapper;

function VerticalVisibilityObserver(window) {
	this._window = window;
	this._viewport = { top: 0, bottom: 0 };
	this._observing = new Map();
	this._handleResize = this._handleResize.bind(this);
	this._handleScroll = this._handleScroll.bind(this);
}

VerticalVisibilityObserver.prototype.observe = function (element, onVisibilityChanged) {
	var info = { top: 0, bottom: 0, isVisible: null, onVisibilityChanged: onVisibilityChanged };

	if (this._observing.size === 0) {
		this._updateViewport();
		this._addListeners();
	}

	this._observing.set(element, info);
	this._updateElement(info, element);
};

VerticalVisibilityObserver.prototype.unobserve = function (element) {
	this._observing.delete(element);

	if (this._observing.size === 0) {
		this._removeListeners();
	}
};

VerticalVisibilityObserver.prototype._addListeners = function () {
	// TODO: Add load and/or orientationchange events?
	this._window.addEventListener('resize', this._handleResize);
	this._window.addEventListener('scroll', this._handleScroll);
};

VerticalVisibilityObserver.prototype._removeListeners = function () {
	this._window.removeEventListener('resize', this._handleResize);
	this._window.removeEventListener('scroll', this._handleScroll);
};

VerticalVisibilityObserver.prototype._updateViewport = function () {
	var top = this._viewport.top = this._window.scrollY;
	var height = this._window.innerHeight;

	this._viewport.bottom = top + height;
};

VerticalVisibilityObserver.prototype._updateElement = function (info, element) {
	info.top = element.offsetTop;
	info.bottom = info.top + element.offsetHeight;

	this._updateElementVisibilty(info, element);
};

VerticalVisibilityObserver.prototype._updateElementVisibilty = function (info, element) {
	var viewport = this._viewport;
	var isVisible = info.top < viewport.bottom && info.bottom > viewport.top;

	if (isVisible !== info.isVisible) {
		info.isVisible = isVisible;
		info.onVisibilityChanged(isVisible, element);
	}
};

VerticalVisibilityObserver.prototype._handleResize = function () {
	this._updateViewport();
	this._observing.forEach(this._updateElement, this);
};

VerticalVisibilityObserver.prototype._handleScroll = function () {
	this._updateViewport();
	this._observing.forEach(this._updateElementVisibilty, this);
};

var verticalVisibilityObserver = VerticalVisibilityObserver;

var main = function main(window) {
	if ('IntersectionObserver' in window && 'IntersectionObserverEntry' in window) {
		return new intersectionObserverWrapper(window);
	}

	return new verticalVisibilityObserver(window);
};

return main;

})));
//# sourceMappingURL=main.min.js.map
